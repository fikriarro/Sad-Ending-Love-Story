<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROYYAN DOCUMENT SCANNER</title>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  padding: 15px;
}

h2 { text-align:center; }

button {
  width:100%;
  padding:14px;
  margin-top:10px;
  font-size:16px;
  border:none;
  border-radius:6px;
  background:#1e88e5;
  color:white;
}

img {
  max-width:100%;
  margin-top:10px;
  border-radius:6px;
  display:none;
}

#status {
  text-align:center;
  margin-top:10px;
  font-weight:bold;
}
</style>
</head>

<body>

<h2>ROYYAN DOCUMENT SCANNER</h2>

<input type="file" accept="image/*" capture="environment" id="cameraInput" hidden>
<input type="file" accept="image/*" id="galleryInput" hidden>

<button onclick="cameraInput.click()">üì∑ Ambil dari Kamera</button>
<button onclick="galleryInput.click()">üñºÔ∏è Ambil dari Galeri</button>

<p id="status">‚è≥ Loading engine...</p>

<img id="preview">
<img id="result">

<button id="autoCropBtn" disabled>‚úÇÔ∏è Auto Crop Dokumen</button>

<script>
let cvReady = false;

function onOpenCvReady() {
  cvReady = true;
  document.getElementById("status").innerText = "‚úÖ Engine siap";
  document.getElementById("autoCropBtn").disabled = false;
}

if (typeof cv !== "undefined") {
  cv['onRuntimeInitialized'] = onOpenCvReady;
}

const preview = document.getElementById("preview");
const result = document.getElementById("result");
const autoCropBtn = document.getElementById("autoCropBtn");

function handleFile(file) {
  const reader = new FileReader();
  reader.onload = () => {
    preview.src = reader.result;
    preview.style.display = "block";
    result.style.display = "none";
  };
  reader.readAsDataURL(file);
}

cameraInput.onchange = e => handleFile(e.target.files[0]);
galleryInput.onchange = e => handleFile(e.target.files[0]);

autoCropBtn.onclick = () => {
  if (!cvReady) return alert("Engine belum siap");

  const img = new Image();
  img.src = preview.src;
  img.onload = () => {
    const canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);

    let src = cv.imread(canvas);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    cv.GaussianBlur(gray, gray, new cv.Size(5,5), 0);
    cv.Canny(gray, gray, 75, 200);

    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    let maxArea = 0;
    let maxContour = null;

    for (let i = 0; i < contours.size(); i++) {
      const cnt = contours.get(i);
      const area = cv.contourArea(cnt);
      if (area > maxArea) {
        maxArea = area;
        maxContour = cnt;
      }
    }

    if (!maxContour) {
      alert("Dokumen tidak terdeteksi");
      return;
    }

    const rect = cv.boundingRect(maxContour);
    const cropped = src.roi(rect);

    cv.imshow(result, cropped);
    result.style.display = "block";

    src.delete(); gray.delete(); contours.delete(); hierarchy.delete();
  };
};
</script>

</body>
</html>
